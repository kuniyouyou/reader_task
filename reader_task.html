<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã®ãŸã‚ã®ã‚¿ã‚¹ã‚¯ç®¡ç†å¸³</title>
    <script src="js/jquery-2.1.3.min.js"></script>
    <link rel="stylesheet" href="css/sample.css">
</head>



<body>
    <header>
        <h1>ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã®ãŸã‚ã®ã‚¿ã‚¹ã‚¯ç®¡ç†å¸³</h1>
    </header>
    <div id="task">
    <p>å…¥åº«æ—¥</p>
    <main stayle="display: ;">
        <textarea id="textarea"></textarea>

    <p>ã‚„ã‚‹ã“ã¨</p>
    <main stayle="display: none;">
        <textarea id="textarea"></textarea>

    <p>æ‹…å½“è€…</p>
    <main stayle="display: none;">
        <textarea id="textarea"></textarea>
        

        <ul>
            <li id="Save">ä¿å­˜</li>
            <li id="Clear">çµ‚äº†</li>
        </ul>
    </div>

        <li id="new">æ–°è¦</li>

        <!-- ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰ã®å ±å‘Šã‚’ãƒãƒ£ãƒƒãƒˆã§ã‚„ã‚Šå–ã‚Šã™ã‚‹ -->
    <p>å ±å‘Šãƒãƒ£ãƒƒãƒˆ</p>
    <div>
        <div> åå‰ï¼š<input type="text" id="uname"> </div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <button id="send">é€ä¿¡</button>
        </div>
        <div id="output" style="overflow: auto;height: 300px;"></div>
    </div> 

    </main>

    <footer><small>G's</small></footer>
    
    <!-- ä¿å­˜ãƒ»å‰Šé™¤è¨­å®š -->
    <script>
        

         // txtå…¥åŠ›éƒ¨åˆ†ã®å‹•ä½œæŒ‡å®š
         $("main").slideDown(500);
        //1.Save ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#Save").on("click",function(){
            // textã‚¨ãƒªã‚¢ã®valã‚’å–å¾—ã™ã‚‹
            const value = $("#textarea").val();
            localStorage.setItem("memo",value);

           alert("ä¿å­˜ã—ã¾ã—ãŸ");
        });



        //2.clear ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#Clear").on("click",function(){
            localStorage.removeItem("memo");
           alert("å‰Šé™¤ã—ã¾ã—ãŸ");
           $("#textarea").val("");
        });




        //3.ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ï¼šä¿å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—è¡¨ç¤º
        if(localStorage.getItem("memo")){
            const value = localStorage.getItem("memo");
            $("#textarea").val(value);
        }


    </script>

    <!-- ãƒãƒ£ãƒƒãƒˆã®å‹•ä½œ -->
<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase **-->
<script type="module">
    // firebaseApikey.jsã‹ã‚‰exportã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’firebaseConfigã¨ã„ã†å¤‰æ•°ã§å–ã‚Šæ‰±ã†ã¨ã„ã†è¨˜è¿°
    import firebaseConfig from "./firebaseApikey.js";
    
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved,update,onChildChanged } 
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    console.log(firebaseConfig);

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
   
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db,"chat");

    $("#send").on("click",function(){
        const msg = {
          uname :  $("#uname").val(),
          text :  $("#text").val()
        }
        const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
        set(newPostRef,msg);
    });

   onChildAdded(dbRef,function(data){
        const msg = data.val();
        const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã€€å‰Šé™¤ãƒ»æ›´æ–°ã«å¿…é ˆï¼ï¼
        let h = '<p id="'+key+'">';
            h += msg.uname;
            h += '<br>';
            h += '<span contentEditable="true" id="'+key+'_update">'+msg.text+'</span>';
            h += '<span class="remove" data-key="'+key+'"> ğŸ†‘</span>';
            h += '<span class="update" data-key="'+key+'"> ğŸ†™</span>';
            h += '</p>';
            $("#output").prepend(h);
   });

  //  å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
   $("#output").on("click", ".remove", function(){
      const key = $(this).attr("data-key");
      const remove_item = ref(db,"chat/"+key);
      remove(remove_item);  // Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
   });

  //  æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
   $("#output").on("click", ".update", function(){
      const key = $(this).attr("data-key");
      update(ref(db, "chat/"+key), {
             text: $("#"+key+'_update').html()
      });
   });

  //  å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
  onChildRemoved(dbRef, (data) => {
    $("#"+data.key).remove(); // DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
  });

  // æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
  onChildChanged(dbRef, (data) =>{
    $("#"+data.key+'_update').html(data.val().text);
    $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
  });


  </script>

</body>
</html>